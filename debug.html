<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debug Console - Fiyat Takip√ßisi Pro</title>
  <link rel="stylesheet" href="m3-tokens.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--md-sys-typescale-font-family-plain);
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header - M3 Top App Bar */
    .header {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      border-radius: var(--md-sys-shape-corner-large);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .header-info h1 {
      font: var(--md-sys-typescale-title-large-font);
      margin-bottom: 2px;
    }

    .header-info p {
      font: var(--md-sys-typescale-body-medium-font);
      opacity: 0.9;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Status Indicator */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--md-sys-shape-corner-full);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.paused {
      background: #fbbf24;
      animation: none;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.6;
        transform: scale(1.2);
      }
    }

    .status-text {
      font: var(--md-sys-typescale-label-large-font);
    }

    /* M3 Button */
    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: var(--md-sys-shape-corner-full);
      font: var(--md-sys-typescale-label-large-font);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-surface {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-surface:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .btn-danger {
      background: var(--md-sys-color-error);
      color: var(--md-sys-color-on-error);
    }

    .btn-danger:hover {
      box-shadow: var(--md-sys-elevation-level1);
    }

    /* Stats Grid - M3 Cards */
    .stats-container {
      background: var(--md-sys-color-surface-container-low);
      padding: 20px 24px;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: var(--md-sys-color-surface);
      padding: 20px;
      border-radius: var(--md-sys-shape-corner-large);
      border: 1px solid var(--md-sys-color-outline-variant);
      transition: all 0.2s;
    }

    .stat-card:hover {
      border-color: var(--md-sys-color-primary);
      box-shadow: var(--md-sys-elevation-level1);
    }

    .stat-label {
      font: var(--md-sys-typescale-label-medium-font);
      color: var(--md-sys-color-on-surface-variant);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font: var(--md-sys-typescale-display-small-font);
      font-weight: 700;
      line-height: 1;
    }

    .stat-value.info {
      color: var(--md-sys-color-primary);
    }

    .stat-value.success {
      color: var(--md-sys-color-success);
    }

    .stat-value.warning {
      color: var(--md-sys-color-warning);
    }

    .stat-value.danger {
      color: var(--md-sys-color-error);
    }

    .stat-subtitle {
      font: var(--md-sys-typescale-body-small-font);
      color: var(--md-sys-color-outline);
      margin-top: 8px;
    }

    /* Main Layout */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--md-sys-color-surface-container);
      border-right: 1px solid var(--md-sys-color-outline-variant);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .filter-section {
      padding: 20px;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }

    .filter-title {
      font: var(--md-sys-typescale-label-large-font);
      color: var(--md-sys-color-on-surface-variant);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .filter-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-btn {
      padding: 12px 16px;
      background: transparent;
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: var(--md-sys-shape-corner-medium);
      color: var(--md-sys-color-on-surface-variant);
      font: var(--md-sys-typescale-label-large-font);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: var(--md-sys-color-surface-container-high);
      border-color: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-surface);
    }

    .filter-btn.active {
      background: var(--md-sys-color-primary);
      border-color: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
    }

    .filter-badge {
      background: var(--md-sys-color-surface-container-high);
      padding: 2px 10px;
      border-radius: var(--md-sys-shape-corner-full);
      font: var(--md-sys-typescale-label-small-font);
      font-weight: 600;
    }

    .filter-btn.active .filter-badge {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Console */
    .console-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--md-sys-color-surface);
    }

    .console-toolbar {
      background: var(--md-sys-color-surface-container-low);
      padding: 12px 20px;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 300px;
      padding: 10px 16px 10px 44px;
      background: var(--md-sys-color-surface);
      border: 1px solid var(--md-sys-color-outline);
      border-radius: var(--md-sys-shape-corner-full);
      color: var(--md-sys-color-on-surface);
      font: var(--md-sys-typescale-body-medium-font);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--md-sys-color-primary);
      border-width: 2px;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--md-sys-color-outline);
    }

    .log-count {
      font: var(--md-sys-typescale-label-medium-font);
      color: var(--md-sys-color-on-surface-variant);
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: var(--md-sys-shape-corner-full);
      color: var(--md-sys-color-on-surface-variant);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-on-surface);
      border-color: var(--md-sys-color-primary);
    }

    .icon-btn.active {
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      border-color: var(--md-sys-color-primary);
    }

    /* Console Output */
    .console-output {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      font-family: 'Google Sans Mono', monospace;
      font-size: 13px;
    }

    .log-entry {
      display: grid;
      grid-template-columns: 90px 100px 1fr;
      gap: 12px;
      padding: 12px 16px;
      border-left: 3px solid transparent;
      margin-bottom: 4px;
      border-radius: var(--md-sys-shape-corner-small);
      transition: background 0.2s;
    }

    .log-entry:hover {
      background: var(--md-sys-color-surface-container-low);
    }

    .log-time {
      color: var(--md-sys-color-outline);
      font-size: 11px;
    }

    .log-source {
      font-weight: 600;
      font-size: 12px;
    }

    .log-message {
      color: var(--md-sys-color-on-surface);
      word-break: break-word;
    }

    .log-entry.info {
      border-left-color: var(--md-sys-color-primary);
    }

    .log-entry.info .log-source {
      color: var(--md-sys-color-primary);
    }

    .log-entry.success {
      border-left-color: var(--md-sys-color-success);
    }

    .log-entry.success .log-source {
      color: var(--md-sys-color-success);
    }

    .log-entry.warning {
      border-left-color: var(--md-sys-color-warning);
      background: rgba(124, 88, 0, 0.08);
    }

    .log-entry.warning .log-source {
      color: var(--md-sys-color-warning);
    }

    .log-entry.error {
      border-left-color: var(--md-sys-color-error);
      background: rgba(179, 38, 30, 0.08);
    }

    .log-entry.error .log-source {
      color: var(--md-sys-color-error);
    }

    .log-entry.error .log-message {
      color: var(--md-sys-color-error);
      font-weight: 500;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--md-sys-color-outline);
      padding: 60px;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-text {
      font: var(--md-sys-typescale-body-large-font);
      text-align: center;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }

      .search-input {
        width: 200px;
      }
    }

    /* Dark mode support */
    body.dark-mode {
      --md-sys-color-surface: #141218;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-left">
      <div class="logo">üõ†Ô∏è</div>
      <div class="header-info">
        <h1>Debug Console</h1>
        <p>Fiyat Takip√ßisi Pro - Real-time Monitoring</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span class="status-text" id="statusText">Aktif</span>
      </div>
      <button class="btn btn-surface" id="pauseBtn" title="Duraklat/Devam">
        <span id="pauseIcon">‚è∏</span>
        <span id="pauseLabel">Duraklat</span>
      </button>
      <button class="btn btn-surface" id="refreshBtn" title="ƒ∞statistikleri Yenile">
        <span>üîÑ</span>
        <span>Yenile</span>
      </button>
      <button class="btn btn-danger" id="clearBtn" title="T√ºm Loglarƒ± Temizle">
        <span>üóëÔ∏è</span>
        <span>Temizle</span>
      </button>
    </div>
  </div>

  <div class="stats-container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Toplam Log</div>
        <div class="stat-value info" id="totalLogs">0</div>
        <div class="stat-subtitle">T√ºm kayƒ±tlar</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Hata</div>
        <div class="stat-value danger" id="errorCount">0</div>
        <div class="stat-subtitle">Kritik hatalar</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Uyarƒ±</div>
        <div class="stat-value warning" id="warningCount">0</div>
        <div class="stat-subtitle">Dikkat gerektiren</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ba≈üarƒ±lƒ±</div>
        <div class="stat-value success" id="successCount">0</div>
        <div class="stat-subtitle">Tamamlanan</div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="sidebar">
      <div class="filter-section">
        <div class="filter-title">Seviye Filtreleri</div>
        <div class="filter-buttons" id="levelFilters">
          <button class="filter-btn active" data-filter="all">
            <span>üìã T√ºm√º</span>
            <span class="filter-badge" id="allCount">0</span>
          </button>
          <button class="filter-btn" data-filter="info">
            <span>‚ÑπÔ∏è Info</span>
            <span class="filter-badge" id="infoCount">0</span>
          </button>
          <button class="filter-btn" data-filter="success">
            <span>‚úÖ Success</span>
            <span class="filter-badge" id="successCountFilter">0</span>
          </button>
          <button class="filter-btn" data-filter="warning">
            <span>‚ö†Ô∏è Warning</span>
            <span class="filter-badge" id="warningCountFilter">0</span>
          </button>
          <button class="filter-btn" data-filter="error">
            <span>‚ùå Error</span>
            <span class="filter-badge" id="errorCountFilter">0</span>
          </button>
        </div>
      </div>
      <div class="filter-section">
        <div class="filter-title">Kaynak Filtreleri</div>
        <div class="filter-buttons" id="sourceFilters"></div>
      </div>
    </div>

    <div class="console-container">
      <div class="console-toolbar">
        <div class="toolbar-left">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Log ara..." />
          </div>
          <div class="log-count">
            <span id="visibleCount">0</span> kayƒ±t g√∂steriliyor
          </div>
        </div>
        <div class="toolbar-actions">
          <button class="icon-btn active" id="scrollBtn" title="Otomatik Scroll">‚¨áÔ∏è</button>
          <button class="icon-btn" id="copyBtn" title="Loglarƒ± Kopyala">üìã</button>
          <button class="icon-btn" id="exportBtn" title="JSON Olarak Dƒ±≈üa Aktar">üíæ</button>
        </div>
      </div>
      <div class="console-output" id="consoleOutput">
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <div class="empty-text">Log kayƒ±tlarƒ± burada g√∂r√ºnecek...<br />Eklenti kullanmaya ba≈ülayƒ±n</div>
        </div>
      </div>
    </div>
  </div>

  <script src="lib/config.js"></script>
  <script src="lib/errors.js"></script>
  <script src="lib/validators.js"></script>
  <script src="lib/cache.js"></script>
  <script src="lib/messaging.js"></script>
  <script src="lib/helpers.js"></script>
  <script>
    const browser = window.browser || window.chrome;
    const isBrowserAPI = () => browser && browser.runtime;

    // State
    const state = {
      logs: [],
      filteredLogs: [],
      currentFilter: 'all',
      currentSource: null,
      searchTerm: '',
      isPaused: false,
      autoScroll: true,
      sources: new Set()
    };

    const counts = { total: 0, info: 0, success: 0, warning: 0, error: 0 };

    // DOM Elements
    const $ = id => document.getElementById(id);

    // Initialize
    function init() {
      setupEventListeners();
      startLogCapture();
      addLog('System', 'info', 'Debug console ba≈ülatƒ±ldƒ±');
      refreshStats();
    }

    function setupEventListeners() {
      // Level filters
      document.querySelectorAll('#levelFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => setFilter(btn.dataset.filter));
      });

      // Action buttons
      $('pauseBtn').addEventListener('click', togglePause);
      $('refreshBtn').addEventListener('click', refreshStats);
      $('clearBtn').addEventListener('click', clearLogs);
      $('scrollBtn').addEventListener('click', toggleAutoScroll);
      $('copyBtn').addEventListener('click', copyLogs);
      $('exportBtn').addEventListener('click', exportLogs);
      $('searchInput').addEventListener('input', e => {
        state.searchTerm = e.target.value;
        filterLogs();
      });
    }

    function startLogCapture() {
      const origLog = console.log;
      const origWarn = console.warn;
      const origError = console.error;

      console.log = (...args) => { origLog.apply(console, args); if (!state.isPaused) captureLog('Console', 'info', args); };
      console.warn = (...args) => { origWarn.apply(console, args); if (!state.isPaused) captureLog('Console', 'warning', args); };
      console.error = (...args) => { origError.apply(console, args); if (!state.isPaused) captureLog('Console', 'error', args); };

      // Demo logs
      setTimeout(() => {
        addLog('Background', 'info', 'Background script initialized');
        addLog('Parser', 'success', 'Product detected: iPhone 15 Pro - 45,999 TL');
        addLog('Background', 'warning', 'Rate limit approaching: 95/100 requests');
      }, 1000);
    }

    function captureLog(source, level, args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      addLog(source, level, msg);
    }

    function addLog(source, level, message) {
      const log = { id: Date.now() + Math.random(), time: new Date(), source, level, message };
      state.logs.push(log);
      state.sources.add(source);
      counts.total++;
      counts[level]++;
      updateCounts();
      updateSourceFilters();
      filterLogs();
    }

    function filterLogs() {
      let filtered = state.logs;
      if (state.currentFilter !== 'all') filtered = filtered.filter(l => l.level === state.currentFilter);
      if (state.currentSource) filtered = filtered.filter(l => l.source === state.currentSource);
      if (state.searchTerm) {
        const term = state.searchTerm.toLowerCase();
        filtered = filtered.filter(l => l.message.toLowerCase().includes(term) || l.source.toLowerCase().includes(term));
      }
      state.filteredLogs = filtered;
      renderLogs();
    }

    function renderLogs() {
      const output = $('consoleOutput');
      if (state.filteredLogs.length === 0) {
        output.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-text">Filtre kriterlerine uygun log bulunamadƒ±</div></div>';
        return;
      }
      output.innerHTML = state.filteredLogs.map(log => `
        <div class="log-entry ${log.level}">
          <div class="log-time">${formatTime(log.time)}</div>
          <div class="log-source">${log.source}</div>
          <div class="log-message">${escapeHtml(log.message)}</div>
        </div>
      `).join('');
      if (state.autoScroll) requestAnimationFrame(() => output.scrollTop = output.scrollHeight);
      $('visibleCount').textContent = state.filteredLogs.length;
    }

    function updateCounts() {
      $('totalLogs').textContent = counts.total;
      $('errorCount').textContent = counts.error;
      $('warningCount').textContent = counts.warning;
      $('successCount').textContent = counts.success;
      $('allCount').textContent = counts.total;
      $('infoCount').textContent = counts.info;
      $('successCountFilter').textContent = counts.success;
      $('warningCountFilter').textContent = counts.warning;
      $('errorCountFilter').textContent = counts.error;
    }

    function updateSourceFilters() {
      const container = $('sourceFilters');
      container.innerHTML = Array.from(state.sources).map(s => `
        <button class="filter-btn${state.currentSource === s ? ' active' : ''}" data-source="${s}">
          <span>üì¶ ${s}</span>
        </button>
      `).join('');
      container.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => setSourceFilter(btn.dataset.source));
      });
    }

    function setFilter(filter) {
      state.currentFilter = filter;
      document.querySelectorAll('#levelFilters .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      filterLogs();
    }

    function setSourceFilter(source) {
      state.currentSource = state.currentSource === source ? null : source;
      updateSourceFilters();
      filterLogs();
    }

    function togglePause() {
      state.isPaused = !state.isPaused;
      $('pauseIcon').textContent = state.isPaused ? '‚ñ∂Ô∏è' : '‚è∏';
      $('pauseLabel').textContent = state.isPaused ? 'Devam' : 'Duraklat';
      $('statusDot').classList.toggle('paused', state.isPaused);
      $('statusText').textContent = state.isPaused ? 'Duraklatƒ±ldƒ±' : 'Aktif';
    }

    function toggleAutoScroll() {
      state.autoScroll = !state.autoScroll;
      $('scrollBtn').classList.toggle('active', state.autoScroll);
    }

    function clearLogs() {
      if (confirm('T√ºm log kayƒ±tlarƒ± silinecek. Devam edilsin mi?')) {
        state.logs = [];
        state.filteredLogs = [];
        Object.keys(counts).forEach(k => counts[k] = 0);
        updateCounts();
        renderLogs();
        addLog('System', 'info', 'Log kayƒ±tlarƒ± temizlendi');
      }
    }

    function copyLogs() {
      const text = state.filteredLogs.map(l => `[${formatTime(l.time)}] [${l.source}] [${l.level.toUpperCase()}] ${l.message}`).join('\n');
      navigator.clipboard.writeText(text).then(() => addLog('System', 'success', 'Loglar panoya kopyalandƒ±'));
    }

    function exportLogs() {
      const data = {
        exportDate: new Date().toISOString(),
        totalLogs: state.logs.length,
        counts,
        logs: state.logs.map(l => ({ time: l.time.toISOString(), source: l.source, level: l.level, message: l.message }))
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug-logs-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      addLog('System', 'success', `${state.logs.length} log kaydƒ± dƒ±≈üa aktarƒ±ldƒ±`);
    }

    async function refreshStats() {
      try {
        if (!isBrowserAPI()) throw new Error('Browser API not available');
        const stats = await browser.runtime.sendMessage({ action: 'getDebugStats' });
        if (stats && !stats.error) {
          addLog('System', 'success', `ƒ∞statistikler g√ºncellendi: ${stats.productsCount || 0} √ºr√ºn`);
        }
      } catch (e) {
        addLog('System', 'error', `ƒ∞statistik hatasƒ±: ${e.message}`);
      }
    }

    function formatTime(date) {
      return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Message listener
    if (isBrowserAPI()) {
      browser.runtime.onMessage.addListener((msg) => {
        if (msg?.action === 'debugLog' && !state.isPaused) {
          addLog(msg.source || 'Unknown', msg.level || 'info', msg.text || '');
        }
      });
    }

    init();
  </script>
</body>

</html>